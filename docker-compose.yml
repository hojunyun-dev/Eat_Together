version: '3.8'

services:
  # Spring Boot 애플리케이션
  eat-together-app:
    build: .
    container_name: eat_together
    ports:
      - "8080:8080"
    networks:
      - monitoring
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
      elasticsearch:
        condition: service_healthy
    environment:
      - spring.data.redis.host=redis
      - spring.data.redis.port=${REDIS_PORT}
      - spring.datasource.url=jdbc:mysql://mysql:${MYSQL_PORT}/${MYSQL_DBNAME}
      - spring.datasource.username=${MYSQL_USERNAME}
      - spring.datasource.password=${MYSQL_PASSWORD}
      - spring.elasticsearch.uris=http://elasticsearch:9200
    env_file:
      - .env

  # MySQL 데이터베이스
  mysql:
    image: mysql:8.0
    container_name: mysql_db
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DBNAME}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - monitoring
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis 캐시 서버
  redis:
    image: redis:7.0-alpine
    container_name: redis-cache
    networks:
      - monitoring
    ports:
      - "6379:6379"

  # Elasticsearch 검색 엔진 (Nori 플러그인 포함)
  elasticsearch:
    build:
      context: .
      dockerfile: Dockerfile.elasticsearch
    container_name: elasticsearch
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    healthcheck:
      test: ["CMD-SHELL", "curl --silent --fail http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - monitoring

  # Elasticsearch 인덱스 초기화
  init-elasticsearch:
    image: curlimages/curl:7.83.1
    container_name: init_elasticsearch
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - monitoring
    command: >
      sh -c "
        until curl --silent --fail http://elasticsearch:9200/_cluster/health > /dev/null; do
          echo 'Waiting for Elasticsearch to be fully ready...';
          sleep 5;
        done;
      
        curl -X PUT 'http://elasticsearch:9200/store' -H 'Content-Type: application/json' -d '{
          \"settings\": {
            \"analysis\": {
              \"tokenizer\": {
                \"nori_tokenizer\": {
                  \"type\": \"nori_tokenizer\",
                  \"decompound_mode\": \"mixed\"
                }
              },
              \"analyzer\": {
                \"nori\": {
                  \"type\": \"custom\",
                  \"tokenizer\": \"nori_tokenizer\",
                  \"filter\": [
                    \"lowercase\"
                  ]
                }
              }
            }
          },
          \"mappings\": {
            \"properties\": {
              \"id\": {
                \"type\": \"keyword\"
              },
              \"normalizationName\": {
                \"type\": \"text\",
                \"analyzer\": \"nori\"
              }
            }
          }
        }'
      "

  # 모니터링 스택
  mysqld_exporter:
    image: prom/mysqld-exporter
    container_name: mysqld_exporter
    ports:
      - "9104:9104"
    depends_on:
      - mysql
    command:
      - "--mysqld.username=${MYSQL_USERNAME}:${MYSQL_PASSWORD}"
      - "--mysqld.address=mysql:${MYSQL_PORT}"
    networks:
      - monitoring

  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: redis-exporter
    command: --redis.addr=redis:6379
    depends_on:
      - redis
    networks:
      - monitoring
    ports:
      - "9121:9121"

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    volumes:
      - ./prometheus/:/etc/prometheus/
    ports:
      - "9090:9090"
    networks:
      - monitoring
    depends_on:
      - redis-exporter
      - eat-together-app
      - mysqld_exporter

  grafana:
    image: grafana/grafana
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./grafana_data:/var/lib/grafana
    networks:
      - monitoring

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.3
    environment:
      ZOOKEEPER_SERVER_ID: 1
      ZOOKEEPER_CLIENT_PORT: 2181
    ports:
      - "22181:2181"
    networks:
      - monitoring

  kafka1:
    image: confluentinc/cp-kafka:7.5.3
    depends_on:
      - zookeeper
    ports:
      - "19092:19092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka1:9092,EXTERNAL://localhost:19092
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
    networks:
      - monitoring

  kafka2:
    image: confluentinc/cp-kafka:7.5.3
    depends_on:
      - zookeeper
    ports:
      - "19093:19093"
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka2:9093,EXTERNAL://localhost:19093
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
    networks:
      - monitoring

  kafka3:
    image: confluentinc/cp-kafka:7.5.3
    depends_on:
      - zookeeper
    ports:
      - "19094:19094"
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka3:9094,EXTERNAL://localhost:19094
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
    networks:
      - monitoring

  kafka-ui:
    image: provectuslabs/kafka-ui
    container_name: kafka-ui
    ports:
      - "8989:8080"
    restart: always
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka1:9092,kafka2:9093,kafka3:9094
      - KAFKA_CLUSTERS_0_ZOOKEEPER=zookeeper:2181
    depends_on:
      - kafka1
      - kafka2
      - kafka3
    networks:
      - monitoring

networks:
  monitoring:
    driver: bridge

volumes:
  grafana_data:
  mysql_data: